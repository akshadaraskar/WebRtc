<!DOCTYPE html>
<html>
<head>
    <style>
        .userbox {
            margin-left: 20px;
            padding: 8px;
            width: 450px;
            /* height:366px; */
            border: 1px solid transparent;
            color: var(--fc-medium);
            border-color: var(--powder-400);
            background-color: burlywood;
            float: left;
        }

        .userbox video {
            display: inline-block;
            border: 1px solid red;
            margin: 0;
            padding: 0;
            width: 450px;
            height: 300px;
        }

        .toolbox {
        }
    </style>
    <meta name="viewport" content="width=device-width" />
    <title>RTC Demo</title>
    <!-- <link href="https://vjs.zencdn.net/7.8.2/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/7.8.2/video.js"></script> -->

    <script src="jquery-3.4.1.min.js"></script>
    <script src="jquery.signalR-2.2.2.min.js"></script>
    <!--<script src="https://webrtcss.azurewebsites.net/signalr/hubs"></script>-->
    <script src="https://localhost:44338/signalr/hubs"></script>
    <!--<script src="video-stream-merger.js"></script>-->
    <script src="demo.js"></script>

    <script>
        var meeting_id = "";
        $(function () {
            const urlParams = new URLSearchParams(window.location.search);
            var user_id = urlParams.get('uid');
            if (!user_id) {
                user_id = window.prompt('Enter your nick!');
            }

            meeting_id = urlParams.get('mid');
            if (!meeting_id) {
                meeting_id = 'TestingMeeting'
            }

            if (!user_id || !meeting_id) {
                alert('user id or meeting id missing');
                return;
            }
            $('#meetingname').text(meeting_id);
            $('#me h2').text(user_id + '(Me)');

            // Set up the SignalR connection
            $.connection.hub.logging = true;
            var hub = $.connection.webRtcHub;
            $.connection.hub.url = 'https://localhost:44338/signalr/hubs';
            //$.connection.hub.url = 'https://webrtcss.azurewebsites.net/signalr/hubs';

            var serverFn = function (data, to_connid) {
                hub.server.exchangeSDP(data, to_connid);
            };

            hub.client.reset = function () {
                location.reload();
            }
            hub.client.exchangeSDP = async function (data, from_connid) {
                //alert(from_connid);
                await Demo.ExecuteClientFn(data, from_connid);
            };

            hub.client.informAboutNewConnection = function (other_user_id, connId) {
                AddNewUser(other_user_id, connId);
                Demo.createNewConnection(connId);
            };

            hub.client.informAboutConnectionEnd = function (connId) {
                $('#' + connId).remove();
                Demo.closeExistingConnection(connId);
            };

            hub.client.showChatMessage = function (from, message, time) {
                var div = $("<div>").text(from + '(' + time + '):' + message);
                $('#messages').append(div);
            }

            $.connection.hub.start(function () {
                console.log('connected to signal server.');
            }).done(function () {

                Demo.init(serverFn, $.connection.hub.id);

                if (user_id != "" && meeting_id != "") {
                    hub.server.connect(user_id, meeting_id).done(function (other_users) {
                        $('#divUsers .other').remove();
                        if (other_users) {
                            for (var i = 0; i < other_users.length; i++) {
                                AddNewUser(other_users[i].user_id, other_users[i].connectionId);
                                Demo.createNewConnection(other_users[i].connectionId);
                            }
                        }
                        $(".toolbox").show();
                    });
                }
            });

            $('#btnResetMeeting').on('click', function () {
                hub.server.reset();
            });

            $('#btnsend').on('click', function () {
                hub.server.sendMessage($('#msgbox').val());
                $('#msgbox').val('');
            });

            function AddNewUser(other_user_id, connId) {
                var $newDiv = $('#otherTemplate').clone();
                $newDiv = $newDiv.attr('id', connId).addClass('other');
                $newDiv.find('h2').text(other_user_id);
                $newDiv.find('video').attr('id', 'v_' + connId);
                $newDiv.find('audio').attr('id', 'a_' + connId);
                $newDiv.show();
                $('#divUsers').append($newDiv);
            }

            $('#divUsers').on('dblclick', 'video', function () {
                this.requestFullscreen();
            });
        });
    </script>
</head>
<body>
    <h1 id='meetingname'></h1>
    <div>
        <div style="width:200px;height:300px;float:left;overflow-y: scroll;" id="messages">
            <div><input type="text" id="msgbox" /><button id="btnsend">Send</button></div>
        </div>
        <div id='divUsers'>
            <div id="me" class="userbox">
                <h2></h2>
                <div>
                    <video autoplay muted id="localVideoCtr" />
                </div>
            </div>
            <div id="otherTemplate" class="userbox" style="display:none">
                <h2></h2>
                <div>
                    <video autoplay muted id="remoteVideoCtr111"></video>
                    <audio autoplay controls style="display:none" id="remoteAudioCtr111"></audio>
                </div>
            </div>
            <!--<audio autoplay controls id="localAudioCtr" ></audio>-->

        </div>
    </div>

    <div style="clear: both;"></div>
    <div class="toolbox" style="display:none">
        <button id="btnMuteUnmute">UnMute</button>
        <button id="btnStartStopCam">Start Camera</button>
        <button id="btnStartStopScreenshare">Screen Share</button>
        <button id="btnResetMeeting">Reset Meeting</button>
    </div>

</body>
</html>